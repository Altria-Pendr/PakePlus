import{_ as J,u as O,j as Q,r as w,b as W,c as o,a as n,g as f,e as c,f as T,k as X,F as C,l as Y,n as H,m as N,p as Z,q as $,s as _,t as R,x as ee,o as l,y as x,z as g,A as L}from"./index-BuWtbWgA.js";import{_ as U}from"./logo-CxXS7KxG.js";import{I as y}from"./icons-BNI7CP4i.js";import{B as I}from"./button-lfGp2GGb.js";import{T as b}from"./toast-D-c1V8F9.js";const se={key:0,class:"helloAnswerBox"},te={class:"card"},ae={key:0,style:{display:"flex","flex-direction":"column",gap:"0.5rem"}},oe={key:1},ne={key:1,class:"messageList"},le={key:0,class:"messageBox"},re={class:"avatar"},ie=["src"],de={key:1,class:"defAvatar"},ue={class:"content"},ce={key:1,class:"messageBox assistant"},ve={class:"content"},ge={key:0,class:"loader"},pe={key:2,class:"imgBox"},me=["src"],fe={key:3,class:"quickButton"},_e={key:0,class:"title"},ye={style:{height:"100%",display:"flex","flex-direction":"row",gap:"5px"}},he=["onClick"],ke=["onClick"],we=["onClick"],xe=["placeholder","disabled"],be={__name:"index",props:{isMobile:{type:Boolean,required:!0}},setup(q){const m=O(),S=Q(),v=w([]),A=w(),M=w(),h=w(),i=w();async function F(){S.setLoadingStatus(!0);const[r,e]=await $("/api/v1/info/GetUserInfo").finally(()=>{S.setLoadingStatus(!1)});if(e)b("用户信息加载失败:"+(e.response.data.message||e.message||"未知错误"));else{A.value=r.data;const[s,t]=await $("/api/v1/user/ProfilePicture",{responseType:"blob"});if(t)b("头像加载失败: "+(t.response.data.message||t.message||"未知错误"));else if(s.data.type!="application/json"){const a=new FileReader;a.onload=()=>{M.value=a.result},a.onerror=u=>{b("头像加载失败"),console.error("Base64转换失败:",u)},a.readAsDataURL(s.data)}}}W(()=>{m.loginStatus&&F()});const z=()=>Math.random().toString(36).substring(2),d=r=>v.value.find(e=>e.id===r),E=r=>{v.value=v.value.filter(e=>e.id!==r)},P=async r=>{for(;;){const[e,s]=await $(`/api/v1/mix_picture/${r}`);if(s)return[null,s];if(e.data.code!==200)return[null,{response:e}];if(e.data.result.finished){const t=e.data.result.images_url[0];try{return[await ee.get(t,{responseType:"blob"}),null]}catch(a){return[null,a]}}await new Promise(t=>setTimeout(t,1e3))}},V=async r=>{const[e,s]=await R("/api/v1/GetTitle",{prompt:r});if(s)return"获取失败";{let t=e.data.title;return t.includes("**")&&(t=t.match(/\*\*(.*?)\*\*/)[1]||t),t.includes("“")&&(t=t.match(/“(.*?)”/)[1]||t),t.includes('"')&&(t=t.match(/"(.*?)"/)[1]||t),t}},p=async(r,e)=>{if(_(()=>{i.value.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})}),!r&&!e)return;if(e)E(e);else{const t=z();v.value.push({role:"user",content:r,id:t}),_(()=>{i.value.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})})}async function s(){const t=JSON.stringify(v.value.map(k=>({role:k.role,content:k.content}))),a=z();v.value.push({role:"assistant",content:"",loading:!0,err:!1,img:"",title:"",id:a,mix_id:""}),_(()=>{i.value.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})});const[u,G]=await R("/api/v1/user/clothes/requestMix",{messages:t});if(!G)if(u.data.code===200&&u.data.data.code===200){d(a).content=u.data.data.result.task_params.raw_prompt,d(a).mix_id=u.data.mix_id;const[k,B]=await P(u.data.data.result.task_id);if(console.log(k,B),B){_(()=>{i.value.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})}),d(a).err=!0,d(a).loading=!1,d(a).content="获取结果失败："+(B.response.data.message||B.message||"未知错误");return}const D=new FileReader;D.readAsDataURL(k.data),D.onloadend=async()=>{_(()=>{i.value.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})});const K=D.result;d(a).loading=!1,d(a).img=K,d(a).title=await V(u.data.data.result.task_params.raw_prompt)}}else _(()=>{i.value.scrollTo({top:i.value.scrollHeight,behavior:"smooth"})}),d(a).err=!0,d(a).loading=!1,d(a).content="获取结果失败："+(u.data?.data?.msg||u.data?.message||"未知错误")}await s()},j=async(r,e)=>{S.setLoadingStatus(!0);const[s,t]=await R("/api/v1/user/clothes/addFavourite",{mix_id:r,title:e}).finally(()=>{S.setLoadingStatus(!1)});t?(console.log(t),b("收藏失败")):b("收藏成功")};return(r,e)=>(l(),o(C,null,[n("div",{ref_key:"answerSpaceRef",ref:i,class:H(["answerSpace",!v.value.length>0?"center":""])},[!v.value.length>0?(l(),o("div",se,[e[11]||(e[11]=n("div",{class:"logo"},[n("img",{src:U,alt:"Logo"})],-1)),n("div",te,[e[10]||(e[10]=n("span",{class:"aboutMe"}," 你好，我是穿搭助手，擅长个性化、场合适配、潮流时尚的穿搭。遇到穿搭难题时可以问我，我会为你解答。 ",-1)),f(m).loginStatus?(l(),o("div",ae,[c(I,{onClick:e[0]||(e[0]=s=>p("用我的衣橱搭配"))},{default:T(()=>e[6]||(e[6]=[x(" 用我的衣橱搭配 ")])),_:1,__:[6]}),c(I,{onClick:e[1]||(e[1]=s=>p("舞会/正式 穿搭"))},{default:T(()=>e[7]||(e[7]=[x(" 舞会/正式 穿搭 ")])),_:1,__:[7]}),c(I,{onClick:e[2]||(e[2]=s=>p("潮流时尚穿搭"))},{default:T(()=>e[8]||(e[8]=[x(" 潮流时尚穿搭 ")])),_:1,__:[8]})])):(l(),o("div",oe,[c(I,{onClick:e[3]||(e[3]=s=>f(X).push({name:"login"}))},{default:T(()=>[c(y,{class:"icon",name:"arrow-square"}),e[9]||(e[9]=x(" 您还未登录 "))]),_:1,__:[9]})]))])])):(l(),o("div",ne,[(l(!0),o(C,null,Y(v.value,s=>(l(),o(C,{key:s.content},[s.role==="user"?(l(),o("div",le,[n("div",re,[M.value?(l(),o("img",{key:0,src:M.value,alt:"avatar"},null,8,ie)):(l(),o("div",de,[n("i",null,L(A.value?.UserName?.substring(0,1)),1)]))]),n("div",ue,L(s.content),1)])):g("",!0),s.role==="assistant"?(l(),o("div",ce,[e[12]||(e[12]=n("div",{class:"avatar"},[n("img",{src:U,alt:"avatar"})],-1)),n("div",ve,[s.loading?(l(),o("div",ge)):g("",!0),s.err?(l(),o(C,{key:1},[x(L(s.content),1)],64)):g("",!0),s.img?(l(),o("div",pe,[n("img",{src:s.img},null,8,me)])):g("",!0),s.img?(l(),o("div",fe,[s.title?(l(),o("div",_e,L(s.title),1)):g("",!0),n("div",ye,[n("div",{class:"button",onClick:t=>j(s.mix_id,s.title)},[c(y,{name:"star"})],8,he),n("div",{class:"button",onClick:t=>p(null,s.id)},[c(y,{name:"rotate-ccw"})],8,ke)])])):g("",!0)]),s.err?(l(),o("div",{key:0,class:"repeat",onClick:t=>p(null,s.id)},[c(y,{name:"rotate-ccw"})],8,we)):g("",!0)])):g("",!0)],64))),128))]))],2),n("div",{class:H(["input",q.isMobile?"mobileInputSpace":""])},[c(y,{name:"chat-stars",noDiv:"",class:"left",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"}),n("input",{class:"search",type:"text",placeholder:f(m).loginStatus?"我可以帮助您什么？":"您还未登录",disabled:!f(m).loginStatus,ref_key:"input",ref:h,onKeyup:e[4]||(e[4]=Z(s=>{p(h.value.value),h.value.value=""},["enter"])),style:N(f(m).loginStatus?{padding:"1rem calc(1rem + var(--icon-size) + 1.5rem) 1rem calc(1rem + var(--icon-size) + 1.5rem)"}:{padding:"1rem 1rem 1rem calc(1rem + var(--icon-size) + 1.5rem)"})},null,44,xe),c(y,{name:"send",noDiv:"",class:"send",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:N(f(m).loginStatus?{}:{display:"none"}),onClick:e[5]||(e[5]=s=>{p(h.value.value),h.value.value=""})},null,8,["style"])],2)],64))}},Ie=J(be,[["__scopeId","data-v-a25f5c5e"]]);export{Ie as default};
